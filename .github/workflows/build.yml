name: Deploy Flask App to AWS EC2

on:
  push:
    branches:
      - master  # Trigger deployment when changes are pushed to the "dev" branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out the repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # Step 2: Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.8  # Update to match your Python version

    # Step 3: Configure SSH to EC2
    - name: Configure SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    # Step 4: Deploy to EC2
    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << EOF
          cd /var/www/flaskapp

          # Pull latest changes
          git pull origin dev

          # Activate virtual environment and install dependencies
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Restart the Flask application (using Gunicorn or systemd)
          sudo systemctl restart flaskapp
        EOF
